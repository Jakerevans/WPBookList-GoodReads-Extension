/**
 * JavaScript Admin Functions - wpbooklist-goodreads-admin.min.js
 *
 * @author   Jake Evans
 * @category JavaScript
 * @package  Includes/Assets/Js
 * @version  6.0.0
 */

console.log( 'This is the Goodreads JavaScript Object that holds all PHP Variables for use in JavaScript' );
console.log( wpbooklistGoodreadsPhpVariables );


// All functions wrapped in jQuery( document ).ready()...
jQuery( document ).ready( function( $ ) {
	'use strict';

	/* BEGINNING SECTION TO CALL ALL FUNCTIONS IN FILE... */

	// Function to display the admin pointer message when entering the Question Mark image with mouse...
	wpbooklistGoodreadsAdminPointersJavascript();

	// Function that will handle the saving of the user's License Key.
	wpbooklistGoodreadsPluginPageDashboardSaveKey();

	// Function to upload a new Goodreads Export.
	wpbooklist_goodreads_add_new_action_javascript();

	// Function to actually add Goodreads titles.
	wpbooklist_goodreads_restore_actual_action_javascript();

	/* ENDING SECTION TO CALL ALL FUNCTIONS IN FILE... */

	// Function that will handle the saving of the user's License Key.
	function wpbooklistGoodreadsPluginPageDashboardSaveKey() {

		// When the 'Save' button is clicked at the top of the dashboard...
		$( '#wpbooklist-extension-genreric-key-dashboard-form-goodreads' ).on( 'submit', function() {

			var license = $( '#wpbooklist-extension-genreric-key-dashboard-input-goodreads' ).val();

			// Make Ajax call to get display options.
			var data = {
				'action': 'wpbooklist_goodreads_save_license_key_action',
				'security': wpbooklistGoodreadsPhpVariables.adminnonce1,
				'license': license
			};

			console.log(data);

			$.post( ajaxurl, data, function( response ) {

				document.location.reload( true );

			});


			event.preventDefault ? event.preventDefault() : event.returnValue = false;

		});

		// When the 'Save' button is clicked from the plugin's entry...
		$( '#wpbooklist-extension-genreric-key-plugins-page-button-goodreads' ).on( 'click', function() {

			var license = $( this ).prev().val();

			// Make Ajax call to get display options.
			var data = {
				'action': 'wpbooklist_goodreads_save_license_key_action',
				'security': wpbooklistGoodreadsPhpVariables.adminnonce1,
				'license': license
			};

			console.log(data);

			$.post( ajaxurl, data, function( response ) {

				document.location.reload( true );

			});
			event.preventDefault ? event.preventDefault() : event.returnValue = false;
		});
	}

	// Function to display the admin pointer message when entering the Question Mark image with mouse...
	function wpbooklistGoodreadsAdminPointersJavascript() {

		$( 'body' ).on( 'mouseenter', '.wpbooklist-icon-image-question', function() {

			var label = $( this ).attr( 'data-label' );
			var pointer;

			// Switch for which admin message to display
			switch ( label ) {
			case 'book-form-isbn10':
				pointer = $( this ).pointer({
					content: '<h3>' + wpbooklistPhpVariables.trans135 + '</h3><p class="wpbooklist-admin-pointer">' + wpbooklistPhpVariables.trans173 + '.</p>',
					position: {
						edge: 'right',
						align: 'right'
					}
				});
				break;
			default:
			}

			// Open the pointer on mouseenter.
			pointer.pointer( 'open' );

			// Close the pointer on mouseleave.
			$( 'body' ).on( 'mouseleave', '.wpbooklist-icon-image-question', function() {
				pointer.pointer( 'close' );
			});

		});

		$( 'body' ).on( 'mouseenter', '.wpbooklist-icon-image-question-with-link', function() {

			var label = $( this ).attr( 'data-label' );
			var pointer;

			// Switch for which admin message to display
			switch ( label ) {
			case 'book-form-libraries':
				pointer = $( this ).pointer({
					content: '<h3>' + wpbooklistPhpVariables.trans203 + '</h3><p class="wpbooklist-admin-pointer">' + wpbooklistPhpVariables.trans204 + wpbooklistPhpVariables.SETTINGS_PAGE_URL + wpbooklistPhpVariables.trans205 + '.</p>',
					position: {
						edge: 'right',
						align: 'right'
					}
				});
				break;
			default:
			}

			// Open the pointer on mouseenter
			pointer.pointer( 'open' );

		});
	}

	// Function to upload a new Goodreads Export.
	function wpbooklist_goodreads_add_new_action_javascript(){

		// Toggle of the checkboxes
		$('#wpbooklist-jre-goodreads-overwrite').change(function(){
	  		if ($(this).is(':checked')) {
	      		$('[name=wpbooklist-jre-goodreads-append]').prop('checked', false);
	  		}
		});
		$('#wpbooklist-jre-goodreads-append').change(function(){
			if ($(this).is(':checked')) {
			  $('[name=wpbooklist-jre-goodreads-overwrite]').prop('checked', false);
			}
		});


		$(document).on("change","#wpbooklist-add-new-goodreads-file", function(evt){

			$('.wpbooklist-spinner').animate({'opacity':'1'});
			$('#wpbooklist-addgoodreads-success-div').html('');

			var files = evt.target.files; // FileList object
		    var theFile = files[0];
		    // Open Our formData Object
		    var formData = new FormData();
		    formData.append('action', 'wpbooklist_goodreads_add_new_action');
		    formData.append('my_uploaded_file', theFile);
		    var nonce = wpbooklistGoodreadsPhpVariables.adminnonce2;
		    formData.append('security', nonce);

			$.ajax({
				url: ajaxurl,
				type: 'POST',
				data: formData,
				contentType:false,
				processData:false,
				success: function(response){
					$('.wpbooklist-spinner').animate({'opacity':'0'});
					$('html, body').animate({
				        scrollTop: $("#wpbooklist-addgoodreads-success-div").offset().top-100
				    }, 1000);

					if(response == 1){
						$('#wpbooklist-addgoodreads-success-div').html('<span id="wpbooklist-add-book-success-span">Success!</span><br/><br/> You\'ve added a new GoodReads Export!<div id="wpbooklist-addstylepak-success-thanks">Thanks for using WPBooklist! If you happen to be thrilled with WPBookList, then by all means, <a id="wpbooklist-addbook-success-review-link" href="https://wordpress.org/support/plugin/wpbooklist/reviews/?filter=5">Feel Free to Leave a 5-Star Review Here!</a><img id="wpbooklist-smile-icon-1" src="' + wpbooklistPhpVariables.ROOT_IMG_ICONS_URL + 'happy.svg"></div>');
					} else {
						$('#wpbooklist-addgoodreads-success-div').html('<span id="wpbooklist-add-book-success-span">Uh-Oh!</span><br/><br/>Looks like there was a problem uploading your GoodReads Export! Please make sure you haven\'t changed the name of the GoodReads Export (it should be something every similar to \'goodreads_library_export.csv\'), and try again.');
					}
					console.log(response)
					//document.location.reload();
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.log(errorThrown);
		            console.log(textStatus);
		            console.log(jqXHR);
				}
			}); 

			evt.preventDefault ? evt.preventDefault() : evt.returnValue = false;

	  	});

	}

	// Function to actually add Goodreads titles.
	function wpbooklist_goodreads_restore_actual_action_javascript() { 
	

  		// For controlling the disabling of the 'Import Selected Goodreads File' button
  		$("#wpbooklist_select_backup_box").change(function(){
			var fileSelect = $("#wpbooklist_select_backup_box").val();
			var libSelect = $("#wpbooklist_goodreads_library_box").val();
			var appendChecked = $('[name=wpbooklist-jre-goodreads-append]').prop('checked');
			var overwriteChecked = $('[name=wpbooklist-jre-goodreads-overwrite]').prop('checked');
			if((fileSelect != null) && (libSelect != null) &&  ((appendChecked == true) || (overwriteChecked == true))){
			  $("#wpbooklist-submit-goodreads").attr('disabled', false);
			}else {
			  $("#wpbooklist-submit-goodreads").attr('disabled', true);
			}
		});

		$("#wpbooklist_goodreads_library_box").change(function(){
			var fileSelect = $("#wpbooklist_select_backup_box").val();
			var libSelect = $("#wpbooklist_goodreads_library_box").val();
			var appendChecked = $('[name=wpbooklist-jre-goodreads-append]').prop('checked');
			var overwriteChecked = $('[name=wpbooklist-jre-goodreads-overwrite]').prop('checked');
			if((fileSelect != null) && (libSelect != null) &&  ((appendChecked == true) || (overwriteChecked == true))){
			  $("#wpbooklist-submit-goodreads").attr('disabled', false);
			}else {
			  $("#wpbooklist-submit-goodreads").attr('disabled', true);
			}
		});

		$('[name=wpbooklist-jre-goodreads-append]').change(function(){
			var fileSelect = $("#wpbooklist_select_backup_box").val();
			var libSelect = $("#wpbooklist_goodreads_library_box").val();
			var appendChecked = $('[name=wpbooklist-jre-goodreads-append]').prop('checked');
			var overwriteChecked = $('[name=wpbooklist-jre-goodreads-overwrite]').prop('checked');
			if((fileSelect != null) && (libSelect != null) &&  ((appendChecked == true) || (overwriteChecked == true))){
			  $("#wpbooklist-submit-goodreads").attr('disabled', false);
			}else {
			  $("#wpbooklist-submit-goodreads").attr('disabled', true);
			}
		});

		$('[name=wpbooklist-jre-goodreads-overwrite]').change(function(){
			var fileSelect = $("#wpbooklist_select_backup_box").val();
			var libSelect = $("#wpbooklist_goodreads_library_box").val();
			var appendChecked = $('[name=wpbooklist-jre-goodreads-append]').prop('checked');
			var overwriteChecked = $('[name=wpbooklist-jre-goodreads-overwrite]').prop('checked');
			if((fileSelect != null) && (libSelect != null) &&  ((appendChecked == true) || (overwriteChecked == true))){
			  $("#wpbooklist-submit-goodreads").attr('disabled', false);
			} else {
			  $("#wpbooklist-submit-goodreads").attr('disabled', true);
			}
		});

	  	$("#wpbooklist-submit-goodreads").click(function(event){

	  		$('.wpbooklist-spinner').animate({'opacity':'1'});
	  		$('#wpbooklist-addgoodreads-success-div').html('');

	  		var fileName = jQuery("#wpbooklist_select_backup_box").val();
		    var library = jQuery("#wpbooklist_goodreads_library_box").val();
		    var appendChecked = jQuery('[name=wpbooklist-jre-goodreads-append]').prop('checked');
		    var overwriteChecked = jQuery('[name=wpbooklist-jre-goodreads-overwrite]').prop('checked');
		    var pageyes = jQuery('#wpbooklist-jre-goodreads-create-page').prop('checked');
		    var postyes = jQuery('#wpbooklist-jre-goodreads-create-post').prop('checked');
		    var woocommerce = jQuery('#wpbooklist-jre-goodreads-create-woo').prop('checked');

		    var howToUpload;
		    if(appendChecked == true){
		      howToUpload = 'append';
		    } else{
		      howToUpload = 'overwrite';
		    }

		  	var data = {
				'action': 'wpbooklist_goodreads_restore_actual_action',
				'security': wpbooklistGoodreadsPhpVariables.adminnonce3,
				'filename' : fileName,
          		'library' : library,
          		'howtoupload' : howToUpload,
          		'pageyes':pageyes,
          		'postyes':postyes,
          		'woocommerce':woocommerce
			};
			console.log(data);

	     	var request = $.ajax({
			    url: ajaxurl,
			    type: "POST",
			    data:data,
			    timeout: 0,
			    success: function(response) {
			    	if(response == 1){
			    		$('#wpbooklist-addgoodreads-success-div').html('<span id="wpbooklist-add-book-success-span">Success!</span><br/><br/> Your Goodreads Export is uploading! Be patient though - it can take quite some time for the upload to complete.<div id="wpbooklist-addstylepak-success-thanks">Thanks for using WPBooklist! If you happen to be thrilled with WPBookList, then by all means, <a id="wpbooklist-addbook-success-review-link" href="https://wordpress.org/support/plugin/wpbooklist/reviews/?filter=5">Feel Free to Leave a 5-Star Review Here!</a><img id="wpbooklist-smile-icon-1" src="' + wpbooklistPhpVariables.ROOT_IMG_ICONS_URL + 'happy.svg"></div>');
			    	}
			    	$('.wpbooklist-spinner').animate({'opacity':'0'});
			    	console.log(response);
			    },
				error: function(jqXHR, textStatus, errorThrown) {
					console.log(errorThrown);
		            console.log(textStatus);
		            console.log(jqXHR);
				}
			});

			event.preventDefault ? event.preventDefault() : event.returnValue = false;
	  	});
	}


















});
